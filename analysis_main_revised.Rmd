---
title: "Revised Analysis"
output: html_notebook
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", echo = FALSE)

# disable dplyr::summarise() grouping message
# also disable stringsasfactors
options(dplyr.summarise.inform = FALSE,
        stringsAsFactors = FALSE)

#load libraries
library("here")
library("beepr")
library("data.table")
library("cowplot")
library("magick")
library("lme4")
library("lmerTest")
library("multcompView")
library("rgbif")
library("raster")
library("rlang")
library("ggplot2")
library("tidyr")
library("dplyr")
library("stringr")
library("forcats")


# Vars ----------------------------------------------------

## Analysis parameters ------------------------------------

#set min threshold of species records in a year
thr.spec <- 10

# set minimum of percent of period covered
thr.perc <- 0.4

# set threshold for min # of records per decade for decadal averages
# based on raw occurrence data
thr.dec.rec <- 10

# set threshold for min # of years per decade for decadal averages
# based on yearly average data
thr.dec.year <- 5

# thresholds for short term phenology changes
thr.2k.min <- 2010
thr.2k.max <- 2019

#set cutoff for earliest year of records and last year
year.start <- 1960
year.stop <- 2019

#set cutoff for decadal records
dec.start <- 1960
dec.stop <- 2010

# for dec computation on yearly basis
dec.year.start <- 1970
dec.year.stop <- dec.stop

# #set max months of flowering threshold (redo pruning after changing)
# thr.FlDur <- 12

## Plotting options ---------------------------------------

# give level of additional plots
# full -> do everything
# base -> only base analysis (or just leave it blank for now)
# or a vector of desired options
# one of 
# - int.slopes.year: plots interactions on species level (mean.doy vs time/temp)
# - traits: analyses all plant traits and their influence on response over time
#           and temp
# - all.spec: plots all species reaction to time in one plot
# - int.slopes.dec: same as spec int slope but on the level of difference 
#                 of doy and in decades
# - data.quality.assessment: plots all occurrence records of 
#                           plants and pollinators in one each
#                           (not included in full, requires more than 8 GB 
#                           of RAM (right now at least))
# - additional:   * spatial occurrence distributions by institution
#                 * spatial occurrence distribution overall
#                 * decadal spatial occurrence distribution
#                 * doy distribution over the year for (for now only)
#                   all Butterfly species (to estimate the degree of
#                   multivoltism)
# - species: plots yearly mean doys and regression for each species
opts <- c('base')

# this vector is used to check whether options are valid
val_opts <- c('full',
              'base',
              'int.slopes.year',
              'int.slopes.year.time',
              'int.slopes.year.temp',
              'traits',
              'all.spec',
              'int.slopes.dec',
              'data.quality.assessment',
              'additional',
              'species')

opts_are_val <- opts %in% val_opts

if (!all(opts_are_val)) {
  stop(str_glue('Options {paste(opts[!opts_are_val], collapse = ', ')}',
                'are not valid for this analysis script.\n',
                'Please check whether they are spelled correctly'))
}

## Control options ----------------------------------------

### General -----------------------------------------------

# force running of the entire script regardless of no new changes in the data?
# if FALSE, workspace data from previous run will be loaded
force.main <- FALSE

# force pruning? (necessary after changing earliest year cutoff)
force.pruning <- FALSE

# force calculation of mean doys? (better to only set it to FALSE if you're 
# really impatient)
force.averaging <- FALSE

# keep raw occurrence files from download? 
# enabling this will retain the huge files downloaded from gbif containing 
# raw occurrence data
# useful when working on that part of the get_occurrence_data script, so you 
# don't have to download everything again. All the files take up 
# about 22 GB when kept.
delete.occ.download <- TRUE

### Climate download --------------------------------------

# control climate data script running
# if set to false the script may still run if no climate data files with the
# right name are not found in the static_data folder
force.clim.get <- FALSE

# control whether the climate data script needs to delete its downloads
# downloads take up about 40 MB
delete.clim.download <- TRUE

### Plant trait download ----------------------------------

# control bioflor scraping script running
# if set to false the script may still run if plant trait files with the
# right name are not found in the static_data folder
force.traits.get <- FALSE

## Set graphics parameters --------------------------------

# set colour for raw data points
col.pt <- "gray31"

# set colour for static lines
col.line <- "gray31"

# set colour for axis elements
col.ax <- "gray31"

# set col for annotations
col.note <- "gray31"

# annotation text size
annot_text <- 20

# line types
lty.sec <- 3

# line size
hline_size_large <- 2
line_size_large <- 2.5

# text size
text_size_large <- 50
legend_text_size_large <- 40

# axis parameters
axis_size_large <- 2
axis_ticks_size_large <- 2
axis_ticks_length_large <- 16

# size of plot labels for cowplot
# when plots were optimized for 22 x 14 in
label_size <- 50

### define trivial group names ----------------------------------------------

# set groups to be excluded
excl.group.year <- c("Diptera", "Hymenoptera")

# set named vector for recoding group names to common names
recode.vec <- c(
  "Coleoptera" = "Beetles",
  "Diptera" = "Flies",
  "Hymenoptera" = "Bees",
  "Lepidoptera" = "Butterflies/\nMoths"
)

# make alternative vector for interactions
recode.vec.int <- recode.vec[2:4]
recode.vec.int[1:3] <- c("Hoverfly - Plant", "Bee - Plant", "Butterfly - Plant")


# translate to trivial names
excl.trivial.year <- recode_factor(excl.group.year, !!! recode.vec)

### set colour tables -------------------------------------------------------

# define colours
# DO NOT CHANGE ORDER, only append
col.grp <-
  data.frame(
    group = c(
      "Beetles",
      "Flies",
      "Bees",
      "Butterflies/\nMoths",
      "Insects overall",
      "Plants",
      "Hoverfly - Plant",
      "Bee - Plant",
      "Butterfly - Plant",
      "Overall",
      "Insect dependent",
      "Intermediate",
      "Insect independent"
    ),
    colour = c(
      "#9815db",
      "#f41d0f",
      "#ffa500",
      "#4744ff",
      "gold",
      "#008a00",
      "#f41d0f",
      "#ffa500",
      "#4744ff",
      "deepskyblue",
      "red",
      "#ffa500",
      "#008a00"
    )
  )

# alternative: named vector
col.grp.vec <- col.grp$colour
names(col.grp.vec) <- col.grp$group

#set colours for Plant-Pollinator comparisons
col.plapoll <- col.grp[5:6,]

# static polls group (no exclusion)
col.poll.stc <- col.grp[1:4,]

#only for polls
col.poll <- col.grp[1:4,] %>% 
  filter(!(group %in% excl.trivial.year))

#only for plants
col.plant <- col.grp[6,]

#set colours for group comparisons (add plant group at the end)
col.group.stc <- bind_rows(col.poll.stc, col.plant)
col.group <- bind_rows(col.poll, col.plant)

#set colours for group comparisons including overall
col.group2.stc <- bind_rows(col.poll.stc, col.plapoll)
col.group2 <- bind_rows(col.poll, col.plapoll)

#set colours for PollDep comparisons
col.PollDep <- col.grp[11:13,]

# interaction colours with standard names
col.int.stc <- col.grp[7:9,]
col.int.stc$group <- c("Hoverfly", "Bee", "Butterfly")

#set colours for Interaction comparisions
col.int <- col.grp[7:9,]

#set colours for Interaction comparison with overall group
col.int2 <- col.grp[7:10,]

#set colours for Interaction group comparisions
col.int3 <- bind_rows(col.int, col.plant)

#set colours for decade comparisons
col.dec <- data.frame(group = c("1990s and before", "all decades", "1990s on"),
                      colour = c("#2F5496", "#972A4B", "#FF0000")
)

# colours for id.grps with scientific scheme
# TODO: Apply colour scheme throughout notebook
col.group.sci <- col.grp$colour[c(1:4, 6)]
names(col.group.sci) <- c("Coleoptera", "Diptera", "Hymenoptera", "Lepidoptera",
                          "Plants")

# Functions -----------------------------------------------

source(here('scripts', 'functions.R'))

# Save options and parameters -----------------------------

# done so that reloading an older workspace does not overwrite changes to
# parameters, options and loaded functions
save.image('data/curr_environment.RData')

```

```{r Ensure additional data is present}

# Climate data --------------------------------------------

if (all(file.exists('static_data/overall_mean_temperature.csv',
                    'static_data/decadal_mean_temperature.csv'))) {
  run.clim.get <- FALSE
} else {
  run.clim.get <- TRUE
}

if (run.clim.get | force.clim.get) {
  source('scripts/get_german_climate_data.R')
}

# Plant trait data ----------------------------------------

if (file.exists('static_data/bioflor_traits.csv')) {
  run.traits.get <- FALSE
} else {
  run.traits.get <- TRUE
}

if (run.traits.get | force.traits.get) {
  source('scripts/get_german_climate_data.R')
}

```

```{r get occurrence data, include=FALSE}
# check if running the script is actually necessary
# this is the case when:
# - it hasn't run before (output files are not present)
# - any of the output files are out of date (older than their
#   source material)
if (all(file.exists(
  here("data", "occurrences_full.csv"),
  here("data", "occurrences_full_refined.csv"),
  here("data", "occurrences_full_pruned.csv"),
  here("data", "species_yearly_mean_doy_raw_based.csv"),
  here("data", "download_ran.txt")

))) {
  
  # files exist, now check for other conditions
  if (
    # check if last keys is younger than the file created after 
    # downloading occurrences
    file.mtime(here("static_data", "last_keys.txt")) >
    file.mtime(here("data", "download_ran.txt")) |
    
    # check if full unrefined occurrence file is older than refined occurrences
    file.mtime(here("data", "occurrences_full.csv")) >
    file.mtime(here("data", "occurrences_full_refined.csv")) |
    
    # check if pruned occurrences are older than output from compiled downloads
    file.mtime(here("data", "occurrences_full_refined.csv")) >
    file.mtime(here("data", "occurrences_full_pruned.csv")) |
    
    # check if averaged occurrences are older than pruned occurrences
    file.mtime(here("data", "occurrences_full_pruned.csv")) >
    file.mtime(here("data", "species_yearly_mean_doy_raw_based.csv"))) {
    
    run.occ.get <- TRUE
    
  } else {
    
    run.occ.get <- FALSE
    
  }
  
  
} else {
  
  run.occ.get <- TRUE
  
}

if(run.occ.get | 
   force.averaging |
   force.pruning |
   any(c('full', 'data.quality.assesment') %in% opts)) {
  
  # run script for retrieving occurrence data from downloaded 
  # gbif datasets (and download them first if necessary)
  # View in RStudio via file.edit(here("scripts", "get_occurrence_data.R"))
  source(here("scripts", "get_occurrence_data.R"), local = TRUE)
  
}

```

## Climate Trends in Germany


```{r It is getting hot in Germany}

dat.temp <- dat.occ %>%
  ungroup() %>%
  distinct(year, y_mean_temp, y_mean_temp.sd)

#generate lm for temp with time
cor.temp <- cor.test(dat.temp$year, dat.temp$y_mean_temp)

cor.temp

#generate plot
p.temp <- ggplot(dat.temp) +
  labs(x = "Year", y = "Yearly mean temperature [\u00B0C]",
       title = "Yearly mean air temperature\n of Germany over time") +
  scale_color_gradient(low = "#2F5496", high = "#FF0000") +
  geom_text(aes(x = 1985, y = 10),
            label = paste0("r =  ", round(cor.temp[["estimate"]], 2)),
            col = "gray38") +
  theme_minimal() +
  theme(legend.position = "none")

p.temp +
  geom_point(aes(year, y_mean_temp, col = y_mean_temp)) +
  geom_smooth(aes(year, y_mean_temp), method = "lm")

```