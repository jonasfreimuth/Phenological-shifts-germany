---
title: "Revised Analysis of phenological shifts in Germany"
output: html_notebook
---



```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", echo = FALSE)

# disable dplyr::summarise() grouping message
# also disable stringsasfactors
options(dplyr.summarise.inform = FALSE,
        stringsAsFactors = FALSE)

library("data.table")
library("rgbif")
library("raster")

# tidyverse stuff last to avoid masking these functions
library("magrittr")
library("forcats")
library("stringr")
library("ggplot2")
library("tidyr")
library("dplyr")
library("tidyselect")

## Functions ----------------------------------------------

source("scripts/functions.R")

# Control variables -------------------------------------------------

## Script control -----------------------------------------

test_run            <- TRUE

# run script for retrieving climate data from DWD regardless of data being 
# already present?
force.clim.get      <- FALSE

# run script for retrieving plant trait data from bioFlor regardless of data 
# being already present?
force.traits.get    <- FALSE

# force running of occurrence getting script
force.occ.get       <- FALSE

# control which of the downloaded files to delete
#   - "all": delete both .zip files and extracted occ .txt files
#   - "zip": delete only .zip files, keep .txt
#   - "txt": delete only .txt files, keep .zip
#   - "non": keep all files in download folder
delete.occ.download <- "non"

# force pruning of data and addition of climate and elevation
force.occ.prune     <- FALSE


## Path names ---------------------------------------------

if (!test_run) {
  dat_occ_file        <- "data/occurrences_full_pruned_clim_elev.csv"
  dat_slope_temp_file <- "data/rnd_eff_temp.csv"
  dat_slope_year_file <- "data/rnd_eff_year.csv"
} else {
  dat_occ_file        <- "data/occurrences_full_pruned_clim_elev_test.csv"
  dat_slope_temp_file <- "data/rnd_eff_temp_test.csv"
  dat_slope_year_file <- "data/rnd_eff_year_test.csv"
}

## Set graphics parameters --------------------------------

# set colour for raw data points
col.pt   <- "gray31"

# set colour for static lines
col.line <- "gray31"

# set colour for axis elements
col.ax   <- "gray31"

# set col for annotations
col.note <- "gray31"

# ribbon alpha
alpha.ribbon            <- 0.3

# annotation text size
annot_text              <- 20

# line types
lty.sec                 <- 3

# line size
hline_size_large        <- 2
line_size_large         <- 2.5

# text size
text_size_large         <- 50
legend_text_size_large  <- 40

# axis parameters
axis_size_large         <- 2
axis_ticks_size_large   <- 2
axis_ticks_length_large <- 16

# size of plot labels for cowplot
# when plots were optimized for 22 x 14 in
label_size              <- 50

## define custom plotting theme ---------------------------

theme_shifts <- function (...) {
  
  theme_minimal() %+replace%
    theme(panel.grid = element_blank(), ...)
  
}

## define trivial group names -----------------------------

# set named vector for recoding group names to common names
recode.vec <- c(
  "Coleoptera"  = "Beetles",
  "Diptera"     = "Flies",
  "Hymenoptera" = "Bees",
  "Lepidoptera" = "Butterflies/\nMoths"
)

# make alternative vector for interactions
recode.vec.int      <- recode.vec[2:4]
recode.vec.int[1:3] <- c("Hoverfly - Plant",
                         "Bee - Plant",
                         "Butterfly - Plant")

### set colour tables -------------------------------------------------------

# define colours
# DO NOT CHANGE ORDER, only append
col.grp <-
  data.frame(group  = c("Beetles",
                        "Flies",
                        "Bees",
                        "Butterflies/\nMoths",
                        "Insects overall",
                        "Plants",
                        "Hoverfly - Plant",
                        "Bee - Plant",
                        "Butterfly - Plant",
                        "Overall",
                        "Insect dependent",
                        "Intermediate",
                        "Insect independent"),
             
             colour = c("#9815db",
                        "#f41d0f",
                        "#ffa500",
                        "#4744ff",
                        "gold",
                        "#008a00",
                        "#f41d0f",
                        "#ffa500",
                        "#4744ff",
                        "deepskyblue",
                        "red",
                        "#ffa500",
                        "#008a00")
  )

# alternative: named vector
col.grp.vec        <- col.grp$colour
names(col.grp.vec) <- col.grp$group

#set colors for Plant-Pollinator comparisons
col.plapoll        <- col.grp[5:6,]

# static polls group (no exclusion)
col.poll.stc       <- col.grp[1:4,]

#only for polls
col.poll           <- col.grp[1:4,] 

#only for plants
col.plant          <- col.grp[6,]

#set colors for group comparisons (add plant group at the end)
col.group.stc      <- bind_rows(col.poll.stc, col.plant)
col.group          <- bind_rows(col.poll, col.plant)

#set colors for group comparisons including overall
col.group2.stc     <- bind_rows(col.poll.stc, col.plapoll)
col.group2         <- bind_rows(col.poll, col.plapoll)

#set colors for PollDep comparisons
col.PollDep        <- col.grp[11:13,]

# interaction colors with standard names
col.int.stc        <- col.grp[7:9,]
col.int.stc$group  <- c("Hoverfly", "Bee", "Butterfly")

#set colors for Interaction comparisons
col.int            <- col.grp[7:9,]

#set colors for Interaction comparison with overall group
col.int2           <- col.grp[7:10,]

#set colors for Interaction group comparisons
col.int3           <- bind_rows(col.int, col.plant)

# colours for id.grps with scientific scheme
# TODO: Apply colour scheme throughout notebook
col.group.sci <- col.grp$colour[c(1:4, 6)]
names(col.group.sci) <- c("Coleoptera",
                          "Diptera",
                          "Hymenoptera",
                          "Lepidoptera",
                          "Plants")

# Save options and parameters -----------------------------

# done so that reloading an older workspace does not overwrite changes to
# parameters, options and loaded functions
save.image('data/curr_environment.RData')

```



```{r Ensure additional data is present}

# Climate data --------------------------------------------

if (all(file.exists('static_data/overall_mean_temperature.csv',
                    'static_data/decadal_mean_temperature.csv'))) {
  run.clim.get <- FALSE
} else {
  run.clim.get <- TRUE
}

if (run.clim.get | force.clim.get) {
  source('scripts/get_german_climate_data.R')
}

# Plant trait data ----------------------------------------

if (file.exists('static_data/bioflor_traits.csv')) {
  run.traits.get <- FALSE
} else {
  run.traits.get <- TRUE
}

if (run.traits.get | force.traits.get) {
  source('scripts/get_bioflor_traits.R')
}

```



```{r get_occurrence_data, include=FALSE}

# for now, only check whether data and random effects are present
if (!any(file.exists(dat_occ_file)) || 
    force.occ.get                   ||
    force.occ.prune) {
  source("scripts/get_occ_data_all_in_one.R")
}

if (!any(file.exists(dat_slope_temp_file, dat_slope_year_file))) {
  source("scripts/run_models.R")
}

```



```{r load_occurrence_slope_data}

# load plant trait data
plant_traits <- fread("static_data/bioflor_traits.csv") %>% 
  
  # prune out some unecessary data
  select(-all_of(c("AccName", "GbifKey", "OrigName", "bioflor_id")))

# load occurrence data
dat.occ <- fread(dat_occ_file, showProgress = FALSE) %>% 
  
  # add trait data
  left_join(plant_traits, by = "species") %>%
  
  # recode id.grp to use trivial names 
  # (recode only takes name/value pairs, so !!! expansion necessary)
  mutate(id.grp = recode_factor(id.grp, !!! recode.vec))


# load slope data
slopes_temp <- fread(dat_slope_temp_file)
slopes_year <- fread(dat_slope_year_file)


# add taxonomic and trait data to slopes
col_vec <- c("kingdom",
             "phylum",
             "id.grp",
             "order",
             "family",
             "genus",
             "species")

tax_df <- dat.occ %>%  
  select(all_of(col_vec)) %>% 
  distinct()
  

slopes_temp <- slopes_temp %>% 
  
  # add taxonomic data
  left_join(tax_df, by = "species") %>% 
  
  # add trait data
  left_join(plant_traits, by = "species")


slopes_year <- slopes_year %>%  
  
  # add taxonomic data
  left_join(tax_df, by = "species") %>% 
  
  # add trait data
  left_join(plant_traits, by = "species")


# generate df giving slopes for both vars
slopes_all <- left_join(slopes_temp,
                        slopes_year,
                        by = c("kingdom",
                               "phylum",
                               "id.grp",
                               "order",
                               "family",
                               "genus",
                               names(plant_traits)),
                        suffix = c("_temp", "_year")) %>% 
  
  # drop redundant cols
  select(-starts_with(c("group_",
                        "main_var_")))

```

## Summary of Shifts  

```{r summarize_slopes}

slopes_temp_sum <- slopes_temp %>% 
  group_by (id.grp) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_sem           = sqrt(sum(slope_std_err ^ 2)) / length(slope),
            slope_ci_min        = slope_mean - slope_sem * 1.96,
            slope_ci_max        = slope_mean + slope_sem * 1.96,
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Temperature")

slopes_year_sum <- slopes_year %>% 
  group_by (id.grp) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_sem           = sqrt(sum(slope_std_err ^ 2)) / length(slope),
            slope_ci_min        = slope_mean - slope_sem * 1.96,
            slope_ci_max        = slope_mean + slope_sem * 1.96,
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Year")

#combine both summary data sets and display them
slopes_all_sum <- left_join(slopes_temp_sum,
                            slopes_year_sum,
                            by = c("id.grp"),
                            suffix = c("_temp",
                                       "_year")) %>% 
  
  # drop redundant columns
  select(-starts_with("var_"))

slopes_all_sum

```



```{r plot_slopes_vs_species_forest}

slopes_temp %>% 
  
  # plot slopes in ascending order
  ggplot() +
  geom_pointrange(aes(x    = reorder(species,  -slope),
                      y    = slope,
                      ymin = slope - slope_std_err * 1.96,
                      ymax = slope + slope_std_err * 1.96,
                      col  = id.grp)) +
  
  # clearly denote the 0 line
  geom_hline(yintercept = 0) +
  
  # invert x and y axis for classic forest plot look
  coord_flip() + 
  
  # break plot into facets, each with an independent species axis
  facet_wrap( ~ id.grp, scale = "free_y") +
  
  # add lables
  labs(title = "Shifts with temperature",
       y = "Slope [days / year] (\u00B1 95% CI) ",
       x = "Species") +
  
  # add coloring
  scale_color_manual(name   = "Group",
                     values = col.grp.vec) +
  
  # remove labeling of individual species (too much information at once)
  theme_shifts(axis.text.y  = element_blank(),
               axis.ticks.y = element_blank())


slopes_year %>% 
  
  # plot slopes in ascending order
  ggplot() +
  geom_pointrange(aes(x    = reorder(species,  -slope),
                      y    = slope,
                      ymin = slope - slope_std_err * 1.96,
                      ymax = slope + slope_std_err * 1.96,
                      col  = id.grp)) +
  
  # clearly denote the 0 line
  geom_hline(yintercept = 0) +
  
  # invert x and y axis for classic forest plot look
  coord_flip() + 
  
  # break plot into facets, each with an independent species axis
  facet_wrap( ~ id.grp, scale = "free_y") +
  
  # add lables
  labs(title = "Shifts with temperature",
       y = "Slope [days / \u00B0C] (\u00B1 95% CI)",
       x = "Species") +
  
  # add coloring
  scale_color_manual(name   = "Group",
                     values = col.grp.vec) +
  
  # remove labeling of individual species (too much information at once)
  theme_shifts(axis.text.y  = element_blank(),
               axis.ticks.y = element_blank())

```

## Analysis of differences between groups

```{r analyse_between_group_diffs}

cat("Differences in slope with temperature:\n\n")

aov_temp <- aov(data = slopes_temp, slope ~ id.grp, 
                weights = 1 / (slope_std_err ^ 2)
                )
summary(aov_temp)

cat("\n Pairwise differences: \n")

ph_aov_temp <- TukeyHSD(aov_temp)
ph_aov_temp

cat("\n\n")
cat("----------------------------------------------------------\n\n")
cat("Differences in slope over time:\n\n")

aov_year <- aov(data = slopes_year, slope ~ id.grp, 
                weights = 1 / (slope_std_err ^ 2)
                )
summary(aov_year)

cat("\n Pairwise differences: \n")

ph_aov_year <- TukeyHSD(aov_year)
ph_aov_year

```



```{r plot_slopes_vs_groups}

# for temp
ggplot() +
  
  # raw data
  geom_point     (data = slopes_temp,
                  aes(x    = id.grp,
                      y    = slope),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar  (data = slopes_temp_sum,
                  aes(x    = id.grp,
                      ymin = slope_ci_min,
                      ymax = slope_ci_max,
                      col  = id.grp)) +
  
  # mean data
  geom_point     (data = slopes_temp_sum,
                  aes(x   = id.grp,
                      y   = slope_mean,
                      col = id.grp)) + 
  
  # line denoting 0
  geom_hline     (yintercept = 0,
                  col = col.line) +
  
  # add labels
  labs(title = "Between group differences in shift",
       subtitle = "with temperature",
       x = "Group",
       y = "Slope [days / \u00B0C] (\u00B1 95% CI)") +
  
  # add coloring
  scale_color_manual(name   = "Group",
                     values = col.grp.vec) +
  
  # suppress legend
  theme_shifts(legend.position = "none")



# for year
ggplot() +
  
  # raw data
  geom_point     (data = slopes_year,
                  aes(x    = id.grp,
                      y    = slope),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar  (data = slopes_year_sum,
                  aes(x    = id.grp,
                      ymin = slope_ci_min,
                      ymax = slope_ci_max,
                      col  = id.grp)) +
  
  # mean data
  geom_point     (data = slopes_year_sum,
                  aes(x   = id.grp,
                      y   = slope_mean,
                      col = id.grp)) + 
  
  # line denoting 0
  geom_hline     (yintercept = 0,
                  col = col.line) +
  
  # add labels
  labs(title = "Between group differences in shift",
       subtitle = "over time",
       x = "Group",
       y = "Slope [days / year] (\u00B1 95% CI)") +
  
  # add coloring
  scale_color_manual(name   = "Group",
                     values = col.grp.vec) +
  
  # suppress legend
  theme_shifts(legend.position = "none")

```


## Analysis of correlation of time and temperature shifts

```{r analyse_year_temp_corr}

# perform correlation test of time and temp slopes for each group and
# store results in df
corr_slopes <- lapply(
  unique(slopes_all$id.grp),
  function(id.grp_var, data = slopes_all) {
    
    slopes_grp <- filter(data, id.grp == id.grp_var)
    
    # make sure data has enough observations for cor.test
    if (nrow(slopes_grp) > 2) {
      
      test <- cor.test(slopes_grp$slope_year,
                       slopes_grp$slope_temp)
      
      res <- data.frame(id.grp = id.grp_var,
                        cor    = test[["estimate"]][["cor"]],
                        t      = test[["statistic"]],
                        df     = test[["parameter"]][["df"]],
                        pval   = test[["p.value"]])
      
      return(res)
      
    } else {
      
      # if we have not enough observations, return the closest thing
      #   to NAs
      res <- data.frame(id.grp = id.grp_var,
                        cor    = NA,
                        t      = "-",
                        df     = "-",
                        pval   = NA)
      
      return(res)
      
    }
    
  })

# bind_rows was acting up, so do.call(rbind) it is
corr_slopes <- do.call(rbind, corr_slopes) %>%
  
  # format pvalues into significance symbols
  mutate(pval.sig = cut(
    pval,
    breaks = c(0, 0.001, 0.01, 0.05, 0.1, 1),
    labels = c("***", "**", "*", ".", " "),
    right  = FALSE )) %>%
  
  # special case of NAs
  mutate(pval.sig = str_replace_na(pval.sig, "-")) %>%
  
  # also add group sizes for plotting (slightly hacky)
  left_join(select(slopes_all_sum, id.grp, n_spec_temp), by = "id.grp")


```



```{r plot_year_vs_temp_slopes_correlation}

ggplot() +
  
  # add 0 lines
  geom_hline     (yintercept = 0, col = col.line) + 
  geom_vline     (xintercept = 0, col = col.line) +
  
  # # add errorbars for raw data
  # geom_errorbar  (data = slopes_all,
  #                 aes(x    = slope_year,
  #                     ymin = slope_temp - slope_std_err_temp,
  #                     ymax = slope_temp + slope_std_err_temp),
  #                 col = col.pt) +
  # 
  # geom_errorbarh (data = slopes_all,
  #                 aes(y    = slope_temp,
  #                     xmin = slope_year - slope_std_err_year,
  #                     xmax = slope_year + slope_std_err_year),
  #                 col = col.pt) +
  
  # add raw data
  geom_point     (data = slopes_all,
                  aes(x = slope_year,
                      y = slope_temp),
                  col = col.pt) + 
  
  # add year errorbar 
  geom_errorbarh (data = slopes_all_sum,
                  aes(y    = slope_mean_temp,
                      xmin = slope_ci_min_year,
                      xmax = slope_ci_max_year,
                      col  = id.grp
                      )) +
  
  # add temp errorbar
  geom_errorbar  (data = slopes_all_sum,
                  aes(x    = slope_mean_year,
                      ymin = slope_ci_min_temp,
                      ymax = slope_ci_max_temp,
                      col  = id.grp))  +
  
  # add group means
  geom_point     (data = slopes_all_sum,
                  aes(x    = slope_mean_year,
                      y    = slope_mean_temp,
                      col  = id.grp)) +
  
  # add group sizes, correlation coefficient and its significance
  geom_text      (data = corr_slopes,
                  
                  # set text at the middle of all time slopes and slightly 
                  #   above the max of all temp slopes
                  aes(x = mean(c(min(slopes_all$slope_year),
                                 max(slopes_all$slope_year))),
                      y = ypos(slopes_all$slope_temp),
                      
                      label = str_glue("n = {n_spec_temp}, ",
                                       "r = {round(cor, 2)}\n{pval.sig}")),
                  col = col.note) +
  
  # adjust ylim to fit text
  ylim(c(min(slopes_all$slope_temp), max(slopes_all$slope_temp) * 2)) +
  
  # split the plot based on the group
  facet_wrap( ~ id.grp) + 
  
  # improve axis lables 
  labs(x = "Shift over time [days / year] (\u00B1 95% CI)",
       y = "Shift with temperature [days / \u00B0C] (\u00B1 95% CI)") +
  
  # add coloring
  scale_color_manual(name   = "Group",
                     values = col.grp.vec) +
  
  # disable the legend
  theme_shifts(legend.position = "none")

```


## Analysis of interaction asynchrony

Here asynchrony is defined as the difference between the peak doy of flowering 
and the peak doy of flight in a given year or at a given temperature. Here, the
peak doys are approximated by the predicted values given by the linear models 
for the corresponding plant and pollinator. The shift in asynchrony is then 
given by the change in the difference between the predicted values over time and
with temperature.

```{r summarize_interactions}

#load interaction data
int_data <- read.csv(paste0("static_data/",
                           "plant_pollinator_interactions_for_potential_",
                           "networks_2018.csv")) %>%
  
  # make names less unwieldy
  rename(poll = POLLINATOR_NAME, plant = PLANT_NAME, group = Group) %>%
  
  # filter out species which have no occurrence data
  filter(
    plant %in% unique(dat.occ$species) &
    poll  %in% unique(dat.occ$species)
    ) %>% 
  
  #add the plant trait data to the interactions
  left_join(plant_traits,
            by = c("plant" = "species")) %>%
  
  #exclude interactions with pollinator independent plants
  filter(PollDep != "No") %>%
  
  #reorder factor levels for more intuitive plotting
  mutate(group = fct_relevel(group, "Hoverfly", "Bee", "Butterfly"))


# display numbers of unique plants and pollinators there are per group
int_data_sum <- int_data %>% 
  select(poll, plant, group) %>% 
  group_by(group) %>% 
  summarise(across(everything(), uniqueN))

int_data_sum

```



```{r compute_asynchrony}

int_slopes_asyn <- int_data %>%
  apply(1, function(int_data_row) {

    # get slope data for plant and poll
    slopes_all_plant <- slopes_all %>%
      filter(species == int_data_row[["plant"]])

    slopes_all_poll  <- slopes_all %>%
      filter(species == int_data_row[["poll" ]])
    
    return(data.frame(

      # get general data on interaction partners
      plant = int_data_row[["plant"]],
      poll  = int_data_row[["poll" ]],
      group = int_data_row[["group"]],

      # extract their slopes with temp
      slope_temp_plant = slopes_all_plant$slope_temp,
      slope_temp_poll  = slopes_all_poll $slope_temp,

      # extract their intercepts with temp
      intcp_temp_plant = slopes_all_plant$intercept_temp,
      intcp_temp_poll  = slopes_all_poll $intercept_temp,

      # compute the difference between both temp slopes
      slope_temp_asyn  = slopes_all_plant$slope_temp -
        slopes_all_poll$slope_temp,
      
      # compute their SEs
      slope_temp_asyn_std_err  = sqrt(
        slopes_all_plant$slope_std_err_temp  ^ 2 +
          slopes_all_poll$slope_std_err_temp ^ 2),
      
      
      # same for intercepts
      intcp_temp_asyn  = slopes_all_plant$intercept_temp - 
        slopes_all_poll$intercept_temp,
      
      # compute their SEs
      intcp_temp_asyn_std_err  = sqrt(
        slopes_all_plant$intercept_std_err_temp  ^ 2 +
          slopes_all_poll$intercept_std_err_temp ^ 2),
      
      
      
      # extract their slopes over time
      slope_year_plant = slopes_all_plant$slope_year,
      slope_year_poll  = slopes_all_poll $slope_year,

      # extract their intercepts with year
      intcp_year_plant = slopes_all_plant$intercept_year,
      intcp_year_poll  = slopes_all_poll $intercept_year,
      
      # compute the difference between both year slopes
      slope_year_asyn  = slopes_all_plant$slope_year -
        slopes_all_poll$slope_year,
      
      # compute their SEs
      slope_year_asyn_std_err  = sqrt(
        slopes_all_plant$slope_std_err_year  ^ 2 +
          slopes_all_poll$slope_std_err_year ^ 2),
      
      
      # same for intercepts
      intcp_year_asyn  = slopes_all_plant$intercept_year - 
        slopes_all_poll$intercept_year,
      
      # compute their SEs
      intcp_year_asyn_std_err = sqrt(
        slopes_all_plant$intercept_std_err_year  ^ 2 +
          slopes_all_poll$intercept_std_err_year ^ 2)))
    
  }) %>%

  bind_rows()

```



```{r analyse_between_group_asynchrony_diffs}

cat("Differences in slope of asynchrony with temperature:\n\n")

aov_asyn_temp <- aov(data = int_slopes_asyn, slope_temp_asyn ~ group,
                     weights = 1 / (slope_temp_asyn_std_err ^ 2))
summary(aov_asyn_temp)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_asyn_temp)

cat("\n\n")
cat("----------------------------------------------------------\n\n")
cat("Differences in slope of asynchrony over time:\n\n")

aov_asyn_year <- aov(data = int_slopes_asyn, slope_year_asyn ~ group,
                     weights = 1 / (slope_year_asyn_std_err ^ 2))
summary(aov_asyn_year)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_asyn_year)

```



```{r summarize_slope_interactions}

int_slopes_asyn_sum <- int_slopes_asyn %>% 
  group_by(group) %>% 
  summarise(n_int                         = length(slope_temp_plant),
            
            # summarize temp asyn
            slope_temp_asyn_mean          = mean(slope_temp_asyn),
            slope_temp_asyn_sd            = sd(slope_temp_asyn),
            slope_temp_asyn_sem           = sqrt(
              sum(slope_temp_asyn_std_err ^ 2)) / length(slope_temp_asyn),
            slope_temp_asyn_ci_min        = slope_temp_asyn_mean - 
              slope_temp_asyn_sem * 1.96,
            slope_temp_asyn_ci_max        = slope_temp_asyn_mean + 
              slope_temp_asyn_sem * 1.96,
            slope_temp_asyn_frac_negative = sum(slope_temp_asyn < 0) /
              length(slope_temp_asyn),
            
            # summarize intercept
            intcp_temp_asyn_mean          = mean(intcp_temp_asyn),
            intcp_temp_asyn_sem           = sqrt(
              sum(intcp_temp_asyn_std_err ^ 2)) / length(intcp_temp_asyn),
            
            
            # summarize year asyn
            slope_year_asyn_mean          = mean(slope_year_asyn),
            slope_year_asyn_sd            = sd(slope_year_asyn),
            slope_year_asyn_sem           = sqrt(
              sum(slope_year_asyn_std_err ^ 2)) / length(slope_year_asyn),
            slope_year_asyn_ci_min        = slope_year_asyn_mean - 
              slope_year_asyn_sem * 1.96,
            slope_year_asyn_ci_max        = slope_year_asyn_mean + 
              slope_year_asyn_sem * 1.96,
            slope_year_asyn_frac_negative = sum(slope_year_asyn < 0) /
              length(slope_year_asyn),
            
            # summarize intercept
            intcp_year_asyn_mean          = mean(intcp_year_asyn),
            intcp_year_asyn_sem           = sqrt(
              sum(intcp_year_asyn_std_err ^ 2)) / length(intcp_year_asyn)
  )


int_slopes_asyn_sum

```



```{r plot_slope_interactions}

# for temp
ggplot() +
  
  # raw data
  geom_point     (data = int_slopes_asyn,
                  aes(x    = group,
                      y    = slope_temp_asyn),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar (data = int_slopes_asyn_sum,
                 aes(x    = group,
                     ymin = slope_temp_asyn_ci_min,
                     ymax = slope_temp_asyn_ci_max,
                     col  = group)) +
  
  # mean data
  geom_point    (data = int_slopes_asyn_sum,
                 aes(x   = group,
                     y   = slope_temp_asyn_mean,
                     col = group)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add labels
  labs(title    = "Interaction asynchrony shifts",
       subtitle = "with temperature",
       x        = "Group",
       y        = "Asynchrony shift [days / \u00B0C] (\u00B1 95% CI)") +
  
  # add color
  scale_color_manual(name   = "Group",
                     values = col.int$colour) +
  
  # suppress legend
  theme_shifts(legend.position = "none")



# for year
ggplot() +
  
  # raw data
  geom_point     (data = int_slopes_asyn,
                  aes(x    = group,
                      y    = slope_year_asyn),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar (data = int_slopes_asyn_sum,
                 aes(x    = group,
                     ymin = slope_year_asyn_ci_min,
                     ymax = slope_year_asyn_ci_max,
                     col  = group)) +
  
  # mean data
  geom_point    (data = int_slopes_asyn_sum,
                 aes(x   = group,
                     y   = slope_year_asyn_mean,
                     col = group)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add labels
  labs(title    = "Interaction asynchrony shifts",
       subtitle = "over time",
       x        = "Group",
       y        = "Asynchrony shift [days / year] (\u00B1 95% CI)") +
  
  # add color
  scale_color_manual(name   = "Group",
                     values = col.int$colour) +
  
  # suppress legend
  theme_shifts(legend.position = "none")

```



```{r simulate_interaction_diff_slopes}

# TODO: give error for estimated points

# TODO: extract this along with random effects
center <- TRUE
scale  <- TRUE

# extract sd and mean for temp and year
# necessary to undo the scaling
sd_temp   <- sd  (dat.occ$temp)
mean_temp <- mean(dat.occ$temp)

sd_year   <- sd  (dat.occ$year)
mean_year <- mean(dat.occ$year)


temp_vec <- unique(scale(dat.occ$temp,
                         center = center,
                         scale  = scale))

year_vec <- unique(scale(dat.occ$year,
                         center = center,
                         scale  = scale))

# for each interaction, derive the difference between the plant and the 
#   pollinator in a given year or at a given temperature
sim_diff_temp <- apply(
  int_slopes_asyn, 1,
  function(int_slopes_row) {
    
    n <- length(temp_vec)
    
    # coercion to numeric necessary as apply treats int_slope_row as a character
    #  matrix
    intercept <- as.numeric(int_slopes_row[["intcp_temp_asyn"]])
    slope     <- as.numeric(int_slopes_row[["slope_temp_asyn"]])
    
    diff_vec  <-  intercept + temp_vec * slope
    
    # if vec has been scaled, undo scaling
    if (center) {
      diff_vec <- diff_vec * sd_temp
      temp_vec <- temp_vec * sd_temp
    }
    if (scale) {
      diff_vec <- diff_vec + mean_temp
      temp_vec <- temp_vec + mean_temp
    }
    
    return(data.frame(
      plant = rep(int_slopes_row[["plant"]], n),
      poll  = rep(int_slopes_row[["poll" ]], n),
      group = rep(int_slopes_row[["group"]], n),
      temp  = temp_vec,
      diff  = diff_vec
      ))
    
  }) %>% 
  
  bind_rows()


sim_diff_year <- apply(
  int_slopes_asyn, 1,
  function(int_slopes_row) {
    
    n <- length(year_vec)
    
    # coercion to numeric necessary as apply treats int_slope_row as a character
    #  matrix
    intercept <- as.numeric(int_slopes_row[["intcp_year_asyn"]])
    slope     <- as.numeric(int_slopes_row[["slope_year_asyn"]])
    
    diff_vec  <-  intercept + year_vec * slope
    
    # if vec has been scaled, undo scaling
    if (center) {
      diff_vec <- diff_vec * sd_year
      year_vec <- year_vec * sd_year
    }
    if (scale) {
      diff_vec <- diff_vec + mean_year
      year_vec <- year_vec + mean_year
    }
    
    return(data.frame(
      plant = rep(int_slopes_row[["plant"]], n),
      poll  = rep(int_slopes_row[["poll" ]], n),
      group = rep(int_slopes_row[["group"]], n),
      year  = year_vec,
      diff  = diff_vec
      ))
    
  }) %>% 
  
  bind_rows()


# summarize per temp differences over groups
sim_diff_temp_sum <- sim_diff_temp %>%
  
  group_by(group, temp) %>%
  
  summarize(diff_n            = length(diff),
            diff_mean         = mean(diff),
            diff_sem          = sqrt( var(diff) / length(diff)),
            diff_ci_min       = diff_mean - 1.96 * diff_sem,
            diff_ci_max       = diff_mean + 1.96 * diff_sem,
            perc_poll_earlier = (sum(diff > 0) / length(diff)) * 100)


# summarize per year differences over groups
sim_diff_year_sum <- sim_diff_year %>%

  group_by(group, year) %>%
  
  summarize(diff_n            = length(diff),
            diff_mean         = mean(diff),
            diff_sem          = sqrt( var(diff) / length(diff)),
            diff_ci_min       = diff_mean - 1.96 * diff_sem,
            diff_ci_max       = diff_mean + 1.96 * diff_sem,
            perc_poll_earlier = (sum(diff > 0) / length(diff)) * 100)


```



```{r plot_diff_slopes}

# for temp
ggplot() +
  
  # add per interaction data
  geom_point(data = sim_diff_temp,
             aes(temp, diff),
             col = col.pt) + 
  
  # add confint for group average data as ribbon
  geom_ribbon(data = sim_diff_temp_sum,
              aes(x    = temp,
                  ymin = diff_ci_min,
                  ymax = diff_ci_max,
                  fill = group),
              alpha = alpha.ribbon) +
  
  # add group average data as a line
  geom_line(data = sim_diff_temp_sum,
            aes(temp, diff_mean, col = group)) +
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add facets
  facet_wrap( ~ group ) +
  
  labs(title    = "Asynchrony in interactions",
       subtitle = "with temperature",
       x        = "Temperature [\u00B0C]",
       y        = "Asynchrony [days] (\u00B1 95% CI)") +
  
  # add color
  scale_color_manual(name       = "Group",
                     values     = col.int$colour,
                     aesthetics = c("col", "fill")) +
  
  # suppress legend
  theme_shifts(legend.position = "none")


# for year
ggplot() +
  
  # add per interaction data
  geom_point(data = sim_diff_year,
             aes(year, diff),
             col = col.pt) + 
  
  # add confint for group average data as ribbon
  geom_ribbon(data = sim_diff_year_sum,
              aes(x    = year,
                  ymin = diff_ci_min,
                  ymax = diff_ci_max,
                  fill = group),
              alpha = alpha.ribbon) +
  
  # add group average data as a line
  geom_line(data = sim_diff_year_sum,
            aes(year, diff_mean, col = group)) +
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add facets
  facet_wrap( ~ group ) +
  
  labs(title    = "Asynchrony in interactions",
       subtitle = "over time",
       x        = "Year",
       y        = "Asynchrony  (\u00B1 95% CI)") +
  
  # add color
  scale_color_manual(name       = "Group",
                     values     = col.int$colour,
                     aesthetics = c("col", "fill")) +
  
  # suppress legend
  theme_shifts(legend.position = "none")

```



```{r plot_poll_early}

# for temp
ggplot(data = sim_diff_temp_sum,
       aes(temp, perc_poll_earlier, col = group)) +
  
  # add group data as points
  geom_line () +
  
  # line denoting 50%
  geom_hline(yintercept = 50,
                 col = col.line) +
  
  # ensure the whole range is visible
  ylim      (c(0, 100)) + 
  
  # add facets
  facet_wrap( ~ group ) +
  
  labs(title    = "Change in earlier partner",
       subtitle = "with temperature",
       x        = "Temperature [\u00B0C]",
       y        = paste("Fraction of interactions with pollinators",
                        "earlier than plants [%]",
                        sep = "\n")) +
  
  # add color
  scale_color_manual(name       = "Group",
                     values     = col.int$colour,
                     aesthetics = c("col", "fill")) +
  
  # suppress legend
  theme_shifts(legend.position = "none")


# for year
ggplot(data = sim_diff_year_sum,
       aes(year, perc_poll_earlier, col = group)) +
  
  # add group data as points
  geom_line () +
  
  # line denoting 50%
  geom_hline(yintercept = 50,
                 col = col.line) +
  
  # ensure the whole range is visible
  ylim      (c(0, 100)) + 
  
  # add facets
  facet_wrap( ~ group ) +
  
  labs(title    = "Change in earlier partner",
       subtitle = "over time",
       x        = "Year",
       y        = paste("Fraction of interactions with pollinators",
                        "earlier than plants [%]",
                        sep = "\n")) +
  
  # add color
  scale_color_manual(name       = "Group",
                     values     = col.int$colour,
                     aesthetics = c("col", "fill")) +
  
  # suppress legend
  theme_shifts(legend.position = "none")

```

## Analysis of influence of plant traits

```{r get_and_sum_plant_traits_slopes}

# filter out species without determined PollDep
#   (includes insects)
slopes_temp_polldep <- slopes_temp %>% 
  drop_na(PollDep)

slopes_year_polldep <- slopes_year %>% 
  drop_na(PollDep)

# summarise data sets
slopes_temp_polldep_sum <- slopes_temp_polldep %>% 
  group_by(PollDep) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_sem           = sqrt(sum(slope_std_err ^ 2)) / length(slope),
            slope_ci_min        = slope_mean - slope_sem * 1.96,
            slope_ci_max        = slope_mean + slope_sem * 1.96,
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Temperature")

slopes_year_polldep_sum <- slopes_year_polldep %>% 
  group_by(PollDep) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_sem           = sqrt(sum(slope_std_err ^ 2)) / length(slope),
            slope_ci_min        = slope_mean - slope_sem * 1.96,
            slope_ci_max        = slope_mean + slope_sem * 1.96,
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Year")

#combine both summary data sets and display them
slopes_all_polldep_sum <- left_join(slopes_temp_polldep_sum,
                                    slopes_year_polldep_sum,
                                    by = c("PollDep"),
                                    suffix = c("_temp",
                                               "_year")) %>% 
  
  # drop redundant columns
  select(-starts_with("var_"))

slopes_all_polldep_sum


```



```{r analyse_plant_traits_slope}

cat("Differences in slope with temperature between levels of pollinator ",
    "dependence:\n\n")

aov_int_temp <- aov(data = slopes_temp_polldep, slope ~ PollDep,
                    weights = 1 / (slope_std_err ^ 2))
summary(aov_int_temp)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_int_temp)

cat("\n\n")
cat("----------------------------------------------------------\n\n")
cat("Differences in in slope over time between levels of pollinator ",
    "dependence:\n\n")

aov_int_year <- aov(data = slopes_year_polldep, slope ~ PollDep,
                    weights = 1 / (slope_std_err ^ 2))
summary(aov_int_year)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_int_year)

```



```{r plot_plant_traits_slope}

# for temp
ggplot() +
  
  # raw data
  geom_point     (data = slopes_temp_polldep,
                  aes(x    = PollDep,
                      y    = slope),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar (data = slopes_temp_polldep_sum,
                 aes(x    = PollDep,
                     ymin = slope_ci_min,
                     ymax = slope_ci_max,
                     col  = PollDep)) +
  
  # mean data
  geom_point    (data = slopes_temp_polldep_sum,
                 aes(x   = PollDep,
                     y   = slope_mean,
                     col = PollDep)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add labels
  labs(title    = "Between group differences in shift",
       subtitle = "with temperature",
       x        = "Group",
       y        = "Slope [days / \u00B0C] (\u00B1 95% CI)") +
  
  # add coloring
  scale_color_manual(name   = "Pollinator Dependency",
                     values = col.PollDep$colour) +
  
  # suppress legend
  theme_shifts(legend.position = "none")



# for year
ggplot() +
  
  # raw data
  geom_point    (data = slopes_year_polldep,
                  aes(x    = PollDep,
                      y    = slope),
                  col = col.pt,
                  position = position_jitter()) +
  
  # error bars
  geom_errorbar (data = slopes_year_polldep_sum,
                 aes(x    = PollDep,
                     ymin = slope_ci_min,
                     ymax = slope_ci_max,
                     col  = PollDep)) +
  
  # mean data
  geom_point    (data = slopes_year_polldep_sum,
                 aes(x   = PollDep,
                     y   = slope_mean,
                     col = PollDep)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # add labels
  labs(title    = "Between group differences in shift",
       subtitle = "over time",
       x        = "Group",
       y        = "Slope [days / year] (\u00B1 95% CI)") +
  
  # add coloring
  scale_color_manual(name   = "Pollinator Dependency",
                     values = col.PollDep$colour) +
  
  # suppress legend
  theme_shifts(legend.position = "none")

```