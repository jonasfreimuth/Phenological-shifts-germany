---
title: "Revised Analysis"
output: html_notebook
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", echo = FALSE)

# disable dplyr::summarise() grouping message
# also disable stringsasfactors
options(dplyr.summarise.inform = FALSE,
        stringsAsFactors = FALSE)

library("data.table")
library("rgbif")
library("raster")

# tidyverse stuff last to avoid masking these functions
library("magrittr")
library("stringr")
library("ggplot2")
library("tidyr")
library("dplyr")
library("tidyselect")

## Functions ----------------------------------------------

source("scripts/functions.R")

# Control variables -------------------------------------------------

## Script control -----------------------------------------

test_run         <- FALSE

# run script for retrieving climate data from DWD regardless of data being 
# already present?
force.clim.get   <- FALSE

# run script for retrieving plant trait data from bioFlor regardless of data 
# being already present?
force.traits.get <- FALSE

# force running of occurrence getting script
force.occ.get <- TRUE

# control which of the downloaded files to delede
#   - "all": delete both .zip files and extracted occ .txt files
#   - "zip": delete only .zip files, keep .txt
#   - "txt": delete only .txt files, keep .zip
#   - "non": keep all files in download folder
delete.occ.download <- "non"


## Path names ---------------------------------------------

if (!test_run) {
  dat_occ_file   <- "data/occurrences_full_pruned_clim_elev.csv"
  dat_slope_year_file <- "data/rnd_eff_year.csv"
  dat_slope_temp_file <- "data/rnd_eff_temp.csv"
} else {
  dat_occ_file   <- "data/f_occurrences_full_pruned_elev_test.csv"
  dat_slope_year_file <- "data/rnd_eff_year_test.csv"
  dat_slope_temp_file <- "data/rnd_eff_temp_test.csv"
}

## Set graphics parameters --------------------------------

# set colour for raw data points
col.pt <- "gray31"

# set colour for static lines
col.line <- "gray31"

# set colour for axis elements
col.ax <- "gray31"

# set col for annotations
col.note <- "gray31"

# annotation text size
annot_text <- 20

# line types
lty.sec <- 3

# line size
hline_size_large <- 2
line_size_large <- 2.5

# text size
text_size_large <- 50
legend_text_size_large <- 40

# axis parameters
axis_size_large <- 2
axis_ticks_size_large <- 2
axis_ticks_length_large <- 16

# size of plot labels for cowplot
# when plots were optimized for 22 x 14 in
label_size <- 50

## define custom plotting theme ---------------------------

theme_shifts <- function (...) {
  
  theme_minimal() %+replace%
    
    theme(panel.grid = element_blank(),
          ...)
}

## define trivial group names -----------------------------

# set groups to be excluded
excl.group.year <- c("Diptera", "Hymenoptera")

# set named vector for recoding group names to common names
recode.vec <- c(
  "Coleoptera" = "Beetles",
  "Diptera" = "Flies",
  "Hymenoptera" = "Bees",
  "Lepidoptera" = "Butterflies/\nMoths"
)

# make alternative vector for interactions
recode.vec.int <- recode.vec[2:4]
recode.vec.int[1:3] <- c("Hoverfly - Plant", "Bee - Plant", "Butterfly - Plant")

# translate to trivial names
excl.trivial.year <- recode_factor(excl.group.year, !!! recode.vec)

### set colour tables -------------------------------------------------------

# define colours
# DO NOT CHANGE ORDER, only append
col.grp <-
  data.frame(
    group = c(
      "Beetles",
      "Flies",
      "Bees",
      "Butterflies/\nMoths",
      "Insects overall",
      "Plants",
      "Hoverfly - Plant",
      "Bee - Plant",
      "Butterfly - Plant",
      "Overall",
      "Insect dependent",
      "Intermediate",
      "Insect independent"
    ),
    colour = c(
      "#9815db",
      "#f41d0f",
      "#ffa500",
      "#4744ff",
      "gold",
      "#008a00",
      "#f41d0f",
      "#ffa500",
      "#4744ff",
      "deepskyblue",
      "red",
      "#ffa500",
      "#008a00"
    )
  )

# alternative: named vector
col.grp.vec <- col.grp$colour
names(col.grp.vec) <- col.grp$group

#set colours for Plant-Pollinator comparisons
col.plapoll <- col.grp[5:6,]

# static polls group (no exclusion)
col.poll.stc <- col.grp[1:4,]

#only for polls
col.poll <- col.grp[1:4,] %>% 
  filter(!(group %in% excl.trivial.year))

#only for plants
col.plant <- col.grp[6,]

#set colours for group comparisons (add plant group at the end)
col.group.stc <- bind_rows(col.poll.stc, col.plant)
col.group <- bind_rows(col.poll, col.plant)

#set colours for group comparisons including overall
col.group2.stc <- bind_rows(col.poll.stc, col.plapoll)
col.group2 <- bind_rows(col.poll, col.plapoll)

#set colours for PollDep comparisons
col.PollDep <- col.grp[11:13,]

# interaction colours with standard names
col.int.stc <- col.grp[7:9,]
col.int.stc$group <- c("Hoverfly", "Bee", "Butterfly")

#set colours for Interaction comparisions
col.int <- col.grp[7:9,]

#set colours for Interaction comparison with overall group
col.int2 <- col.grp[7:10,]

#set colours for Interaction group comparisions
col.int3 <- bind_rows(col.int, col.plant)

#set colours for decade comparisons
col.dec <- data.frame(group = c("1990s and before", "all decades", "1990s on"),
                      colour = c("#2F5496", "#972A4B", "#FF0000")
)

# colours for id.grps with scientific scheme
# TODO: Apply colour scheme throughout notebook
col.group.sci <- col.grp$colour[c(1:4, 6)]
names(col.group.sci) <- c("Coleoptera", "Diptera", "Hymenoptera", "Lepidoptera",
                          "Plants")

# Save options and parameters -----------------------------

# done so that reloading an older workspace does not overwrite changes to
# parameters, options and loaded functions
save.image('data/curr_environment.RData')

```



```{r Ensure additional data is present}

# Climate data --------------------------------------------

if (all(file.exists('static_data/overall_mean_temperature.csv',
                    'static_data/decadal_mean_temperature.csv'))) {
  run.clim.get <- FALSE
} else {
  run.clim.get <- TRUE
}

if (run.clim.get | force.clim.get) {
  source('scripts/get_german_climate_data.R')
}

# Plant trait data ----------------------------------------

if (file.exists('static_data/bioflor_traits.csv')) {
  run.traits.get <- FALSE
} else {
  run.traits.get <- TRUE
}

if (run.traits.get | force.traits.get) {
  source('scripts/get_bioflor_traits.R')
}

```



```{r get_occurrence_data, include=FALSE}

# for now, only check whether data and random effects are present
if (!any(file.exists(dat_occ_file)) || 
    force.occ.get) {
  source("scripts/get_occ_data_all_in_one.R")
}

if (!any(file.exists(dat_slope_temp_file, dat_slope_year_file))) {
  source("scripts/run_models.R")
}

```



```{r load_occurrence_slope_data}

dat.occ <- fread(dat_occ_file)

slopes_temp <- fread(dat_slope_temp_file)
slopes_year <- fread(dat_slope_year_file)

# add taxonomic data to slopes
tax_df <- dat.occ %>% 
  select(c(kingdom, phylum, id.grp, order, family, genus, species)) %>% 
  distinct()
  
slopes_temp <- slopes_temp %>% 
  left_join(tax_df, by = "species")

slopes_year <- slopes_year %>% 
  left_join(tax_df, by = "species")

# generate df giving slopes for both vars
slopes_all <- left_join(slopes_temp,
                        slopes_year,
                        by = c("kingdom",
                               "phylum",
                               "id.grp",
                               "order",
                               "family",
                               "genus",
                               "species"),
                        suffix = c("_temp", "_year")) %>% 
  
  # drop redundant cols
  select(-starts_with(c("group_",
                        "main_var_")))

```

## Summary of Shifts

```{r summarize_slopes}

slopes_temp_sum <- slopes_temp %>% 
  group_by(id.grp) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_se            = sd(slope) / sqrt(length(slope)),
            slope_ci_min        = ci.min(slope),
            slope_ci_max        = ci.max(slope),
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Temperature")

slopes_year_sum <- slopes_year %>% 
  group_by(id.grp) %>% 
  summarise(n_spec              = length(slope),
            slope_mean          = mean(slope),
            slope_sd            = sd(slope),
            slope_se            = sd(slope) / sqrt(length(slope)),
            slope_ci_min        = ci.min(slope),
            slope_ci_max        = ci.max(slope),
            slope_frac_negative = sum(slope < 0) / length(slope),
            var                 = "Year")

#combine both summary data sets and display them
slopes_all_sum <- left_join(slopes_temp_sum,
                            slopes_year_sum,
                            by = c("id.grp"),
                            suffix = c("_temp",
                                       "_year")) %>% 
  
  # drop redundant columns
  select(-starts_with("var_"))

slopes_all_sum

```



```{r plot_slopes_vs_species_forest}

slopes_temp %>% 
  ggplot(aes(reorder(species,  -slope), slope, col = id.grp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  coord_flip() + 
  facet_wrap( ~ id.grp, scale = "free_y") +
  labs(title = "Shifts with temperature",
       y = "Slope",
       x = "Species") +
  theme_shifts(axis.text.y  = element_blank(),
               axis.ticks.y = element_blank())

slopes_year %>% 
  ggplot(aes(reorder(species,  -slope), slope, col = id.grp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  coord_flip() + 
  facet_wrap( ~ id.grp, scale = "free_y") +
  labs(title = "Shifts over time",
       y = "Slope",
       x = "Species") +
  theme_shifts(axis.text.y  = element_blank(),
               axis.ticks.y = element_blank())

```

## Analysis of differences between groups

```{r analyse_between_group_diffs}
cat("Differences in slope with temperature:\n\n")

aov_temp <- aov(data = slopes_temp, slope ~ id.grp)
summary(aov_temp)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_temp)

cat("\n\n")
cat("----------------------------------------------------------\n\n")
cat("Differences in slope over time:\n\n")

aov_year <- aov(data = slopes_year, slope ~ id.grp)
summary(aov_year)

cat("\n Pairwise differences: \n")

TukeyHSD(aov_year)

```



```{r plot_slopes_vs_groups}

# for temp
ggplot() +
  
  # raw data
  geom_jitter   (data = slopes_temp,
                 aes(x = id.grp,
                     y = slope),
                 col = col.pt) +
  
  # errorbars
  geom_errorbar (data = slopes_temp_sum,
                 aes(x    = id.grp,
                     ymin = slope_ci_min,
                     ymax = slope_ci_max,
                     col  = id.grp)) +
  
  # mean data
  geom_point    (data = slopes_temp_sum,
                 aes(x   = id.grp,
                     y   = slope_mean,
                     col = id.grp)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # supress legend
  theme_shifts(legend.position = "none")



# for year
ggplot() +
  
  # raw data
  geom_jitter   (data = slopes_year,
                 aes(x = id.grp,
                     y = slope),
                 col = col.pt) +
  
  # errorbars
  geom_errorbar (data = slopes_year_sum,
                 aes(x    = id.grp,
                     ymin = slope_ci_min,
                     ymax = slope_ci_max,
                     col  = id.grp)) +
  
  # mean data
  geom_point    (data = slopes_year_sum,
                 aes(x   = id.grp,
                     y   = slope_mean,
                     col = id.grp)) + 
  
  # line denoting 0
  geom_hline    (yintercept = 0,
                 col = col.line) +
  
  # supress legend
  theme_shifts(legend.position = "none")

```



```{r plot_year_vs_temp_slopes_correlation}

ggplot() +
  
  # add raw data
  geom_point     (data = slopes_all,
                  aes(x = slope_year,
                      y = slope_temp),
                  col = col.pt) + 
  
  # add year errorbar 
  geom_errorbarh (data = slopes_all_sum,
                  aes(y    = slope_mean_temp,
                      xmin = slope_ci_min_year,
                      xmax = slope_ci_max_year,
                      col  = id.grp
                      )) +
  
  # add temp errorbar
  geom_errorbar  (data = slopes_all_sum,
                  aes(x    = slope_mean_year,
                      ymin = slope_ci_min_temp,
                      ymax = slope_ci_max_temp,
                      col  = id.grp))  +
  
  # add group means
  geom_point     (data = slopes_all_sum,
                  aes(x    = slope_mean_year,
                      y    = slope_mean_temp,
                      col  = id.grp)) +
  
  # split the plot based on the group
  facet_wrap( ~ id.grp) + 
  
  # disable the legend
  theme_shifts(legend.position = "none")

```

